<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Task Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 15px;
      line-height: 1.4;
    }
    h1 { margin-bottom: 10px; }
    label { display: block; margin-top: 10px; }
    input, select, button, textarea {
      padding: 8px;
      margin-top: 5px;
      width: 100%;
      box-sizing: border-box;
    }
    textarea { height: 120px; }
    button { margin-top: 15px; cursor: pointer; }

    .task {
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .high { background: #ffe6e6; }
    .med { background: #fff4e6; }
    .low { background: #e8ffe6; }

    .muted { color: #555; font-size: 0.9em; }
  </style>
</head>

<body>
  <h1>Smart Task Analyzer</h1>

  <h3>Add a Task</h3>
  <form id="task-form">
    <label>Title
      <input id="title" required />
    </label>

    <label>Due Date (YYYY-MM-DD)
      <input id="due_date" placeholder="2025-11-30" />
    </label>

    <label>Estimated Hours
      <input id="estimated_hours" type="number" step="0.25" min="0" value="4" />
    </label>

    <label>Importance (1â€“10)
      <input id="importance" type="number" min="1" max="10" value="5" />
    </label>

    <label>Dependencies (comma-separated IDs)
      <input id="dependencies" placeholder="t1,t2" />
    </label>

    <button type="submit">Add Task</button>
  </form>

  <h3>Bulk JSON Input</h3>
  <textarea id="bulk" placeholder='[
  {"id":"t1","title":"Task","due_date":"2025-12-01","estimated_hours":4,"importance":8}
]'></textarea>

  <label>Strategy
    <select id="strategy">
      <option value="smart_balance">Smart Balance</option>
      <option value="fastest">Fastest Wins</option>
      <option value="high_impact">High Impact</option>
      <option value="deadline">Deadline Driven</option>
    </select>
  </label>

  <button id="analyze">Analyze Tasks</button>
  <button id="suggest">Top 3 Suggestions</button>

  <h3>Local Tasks</h3>
  <div id="local-list" class="muted">No tasks yet.</div>

  <h3>Results</h3>
  <div id="results"></div>

<script>
let localTasks = [];

function renderLocal() {
  const box = document.getElementById("local-list");
  if (localTasks.length === 0) {
    box.innerHTML = "<div class='muted'>No tasks yet.</div>";
    return;
  }
  box.innerHTML = "<ul>" + localTasks.map(
    t => `<li><b>${t.title}</b> (id: ${t.id})</li>`
  ).join("") + "</ul>";
}

document.getElementById("task-form").addEventListener("submit", e => {
  e.preventDefault();

  // clean hours input
  let raw = document.getElementById("estimated_hours").value;
  let hours = 4;
  if (raw.trim() !== "" && !isNaN(parseFloat(raw))) {
    hours = parseFloat(raw);
  }

  const t = {
    id: document.getElementById("title").value.trim().replace(/\s+/g,"-").toLowerCase(),
    title: document.getElementById("title").value.trim(),
    due_date: document.getElementById("due_date").value || null,
    estimated_hours: hours,
    importance: parseInt(document.getElementById("importance").value) || 5,
    dependencies: (document.getElementById("dependencies").value || "")
      .split(",")
      .map(x => x.trim())
      .filter(x => x !== "")
  };

  localTasks.push(t);
  renderLocal();
  e.target.reset();
});

document.getElementById("analyze").addEventListener("click", async () => {
  let tasks = [...localTasks];

  const bulkText = document.getElementById("bulk").value.trim();
  if (bulkText) {
    try {
      const arr = JSON.parse(bulkText);
      if (Array.isArray(arr)) tasks = tasks.concat(arr);
    } catch {
      alert("Bulk JSON invalid!");
      return;
    }
  }

  if (tasks.length === 0) {
    alert("No tasks to analyze");
    return;
  }

  const strategy = document.getElementById("strategy").value;

  try {
    const res = await fetch("http://127.0.0.1:8000/api/tasks/analyze/", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ tasks, strategy })
    });
    const data = await res.json();
    renderResults(data.results);
  } catch(e) {
    alert("Error: " + e.message);
  }
});

document.getElementById("suggest").addEventListener("click", async () => {
  try {
    const res = await fetch("http://127.0.0.1:8000/api/tasks/suggest/");
    const data = await res.json();

    if (!Array.isArray(data.suggestions)) {
      alert("Run Analyze first!");
      return;
    }

    const box = document.getElementById("results");
    box.innerHTML = "<h4>Top 3 Suggestions</h4>";

    data.suggestions.forEach(s => {
      const t = s.task;
      const div = document.createElement("div");
      div.className = "task " + (
        t.score > 0.7 ? "high" :
        t.score > 0.4 ? "med" : "low"
      );
      div.innerHTML = `
        <b>${t.title}</b> <span class="muted">(score ${t.score})</span><br>
        <span class="muted">${s.why}</span>
      `;
      box.appendChild(div);
    });

  } catch(e) {
    alert("Error: " + e.message);
  }
});

function renderResults(results) {
  const out = document.getElementById("results");
  out.innerHTML = "";
  results.forEach(t => {
    const div = document.createElement("div");
    div.className = "task " + (
      t.score > 0.7 ? "high" :
      t.score > 0.4 ? "med" : "low"
    );

    div.innerHTML = `
      <b>${t.title}</b> 
      <span class="muted">(id: ${t.id})</span><br>
      <span class="muted">Score: ${t.score}</span><br>
      <span class="muted">Explanation: ${t.explanation}</span><br>
      <span class="muted">Issues: ${(t.issues || []).join(", ")}</span>
    `;

    out.appendChild(div);
  });
}

renderLocal();
</script>

</body>
</html>
